#!/usr/bin/env groovy
import groovy.json.JsonOutput
import java.util.Optional
import hudson.tasks.test.AbstractTestResultAction
import hudson.model.Actionable
import hudson.tasks.junit.CaseResult

def speedUp = '--configure-on-demand --daemon --parallel'
def out = ""
def author = "";
def message = "";
def slackStudentId = "";
def slackTrainerId = "";
def recipient = new String[2];
def slackNotificationChannel = 'eng-5-build'

def isPublishingBranch = { ->
    return env.GIT_BRANCH == 'origin/master' || env.GIT_BRANCH =~ /release.+/
}

def isResultGoodForPublishing = { ->
    return currentBuild.result == null
}

def notifySlack(text, recipient, attachments) {
    def slackURL = "${env.SLACK_WEBHOOK}"
    def jenkinsIcon = "https://wiki.jenkins-ci.org/download/attachments/2916393/logo.png"
    for (i=0; i<2; i++){
        def payload = JsonOutput.toJson([text: text,
            channel: recipient[i],
            username: "Jenkinsfile test",
            icon_url: jenkinsIcon,
            attachments: attachments
        ]
        )

        sh "curl -X POST --data-urlencode \'payload=${payload}\' ${slackURL}"
    }
}

def getGitAuthor = {
    def commit = sh(returnStdout: true, script: 'git rev-parse HEAD')
    author = sh(returnStdout: true, script: "git --no-pager show -s --format='%an' ${commit}").trim()
}

def getLastCommitMessage = {
    message = sh(returnStdout: true, script: 'git log -1 --pretty=%B').trim()
}

def populateGlobalVariables = {
    getLastCommitMessage()
    getGitAuthor()
    slackStudentId = sh(returnStdout: true, script: "grep -oP '(?<=SlackStudentID:\\s)\\w+' README.md")
    slackTrainerId = sh(returnStdout: true, script: "grep -oP '(?<=SlackTrainerID:\\s)\\w+' README.md")
    recipient[0]= slackStudentId.trim()
    recipient[1]= slackTrainerId.trim()
}


node('ALMS') {
    try {
        stage('Checkout') {
            checkout scm
        }

        stage("Build"){
            sh script: 'rspec spec > log.txt || true'
            // fname = 'out.txt'
            println "merril check"
            sh script: 'cat log.txt'
            println "merril check"
            env.WORKSPACE = pwd()
            out = readFile "${env.WORKSPACE}/log.txt"
            // doesnt work (below)
            // String fileContents = new File('./log.txt').text
            // println out
            // out = fileContents


            populateGlobalVariables()
            println "pop is fine"
            def buildColor = currentBuild.result == null ? "good" : "warning"
            def buildStatus = currentBuild.result == null ? "Success" : currentBuild.result
            def jobName = "${env.JOB_NAME}"
            jobName = jobName.getAt(0..(jobName.indexOf('/') - 1))
            notifySlack("", recipient, [
                [

                    color: "${buildColor}",
                    author_name: "${author}",
                    text: "${buildStatus}\n${author}",
                    fields: [
                        [
                            title: "Branch",
                            value: "${env.BRANCH_NAME}",
                            short: true
                        ],
                        [
                            title: "Test Results",
                            value: """${out}""",
                            short: true
                        ],
                        [
                            title: "Last Commit",
                            value: "${message}",
                            short: false
                        ]
                    ]
                ]
            ])
        }

    } catch (hudson.AbortException ae) {

    } catch (e) {
        def buildStatus = "Failed"
        if (isPublishingBranch()) {
            buildStatus = "MasterFailed"
        }
        notifySlack("", recipient, [
            [

                color: "danger",
                author_name: "${author}",
                text: "${buildStatus}",
                fields: [
                    [
                        title: "Branch",
                        value: "${env.BRANCH_NAME}",
                        short: true
                    ],
                    [
                        title: "Test Results",
                        value: "${out}",
                        short: true
                    ],
                    [
                        title: "Last Commit",
                        value: "${message}",
                        short: false
                    ],
                    [
                        title: "Error",
                        value: "${e}",
                        short: false
                    ]
                ]
            ]
        ])
        throw e
    }
  }


Add CommentCollapseÂ 
